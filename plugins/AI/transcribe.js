const axios = require('axios');
const FormData = require('form-data');
const crypto = require('crypto');

module.exports = async (context) => {
  const { client, m } = context;
  const quoted = m.quoted || m;
  const mime = (quoted.msg || quoted).mimetype || '';

  if (!/audio|video/.test(mime)) {
    return m.reply(`â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œâ”€â”€â”€â‰« EÊ€Ê€á´Ê€ â‰ªâ”€â”€â”€\nâ”œ \nâ”œ Send or reply to an audio/video file with the caption _transcribe_ idiot\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`);
  }

  m.reply(`â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œâ”€â”€â”€â‰« TÊ€á´€É´sá´„Ê€ÉªÊ™ÉªÉ´É¢ â‰ªâ”€â”€â”€\nâ”œ \nâ”œ Processing, please wait...\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`);

  try {
    const buffer = await m.quoted.download();

    if (buffer.length > 5 * 1024 * 1024) {
      return m.reply(`â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œâ”€â”€â”€â‰« EÊ€Ê€á´Ê€ â‰ªâ”€â”€â”€\nâ”œ \nâ”œ Maximum file size is 5 MB.\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`);
    }

    const result = await transcribeWithTalknotes(buffer);

    if (!result || !result.text) {
      return m.reply(`â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œâ”€â”€â”€â‰« Fá´€ÉªÊŸá´‡á´… â‰ªâ”€â”€â”€\nâ”œ \nâ”œ Failed to extract text. Please try again later.\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`);
    }

    return m.reply(`â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œâ”€â”€â”€â‰« TÊ€á´€É´sá´„Ê€Éªá´˜á´›Éªá´É´ â‰ªâ”€â”€â”€\nâ”œ \nâ”œ ${result.text}\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`);
  } catch (error) {
    console.error(error);
    m.reply(`â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œâ”€â”€â”€â‰« EÊ€Ê€á´Ê€ â‰ªâ”€â”€â”€\nâ”œ \nâ”œ An error occurred while processing the file.\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`);
  }
};

function generateToken(secretKey) {
  const timestamp = Date.now().toString();
  const hmac = crypto.createHmac('sha256', secretKey);
  hmac.update(timestamp);
  const token = hmac.digest('hex');

  return {
    'x-timestamp': timestamp,
    'x-token': token
  };
}

async function transcribeWithTalknotes(buffer) {
  try {
    const form = new FormData();
    form.append('file', buffer, {
      filename: 'audio.mp3',
      contentType: 'audio/mpeg'
    });

    const tokenData = generateToken('w0erw90wr3rnhwoi3rwe98sdfihqio432033we8rhoeiw');

    const headers = {
      ...form.getHeaders(),
      ...tokenData,
      'referer': 'https://talknotes.io/',
      'origin': 'https://talknotes.io',
      'user-agent': 'Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Mobile Safari/537.36',
    };

    const { data } = await axios.post('https://api.talknotes.io/tools/converter', form, { headers });

    return data;
  } catch (err) {
    console.error('Talknotes error:', err.message);
    return null;
  }
}