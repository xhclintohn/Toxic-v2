const ownerMiddleware = require('../../utils/botUtil/Ownermiddleware');

module.exports = async (context) => {
    await ownerMiddleware(context, async () => {
        const { client, m, participants, botname, groupMetadata, text, pushname } = context;

        const { getBinaryNodeChild, getBinaryNodeChildren } = require('@whiskeysockets/baileys');

        if (!text) return m.reply(`â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œâ”€â”€â”€â‰« ERROR â‰ªâ”€â”€â”€\nâ”œ \nâ”œ Provide number to be added.\nâ”œ Format: add 254735342808\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`);

        const _participants = participants.map((user) => user.id);

        const users = (await Promise.all(
            text.split(',')
                .map((v) => v.replace(/[^0-9]/g, ''))
                .filter((v) => v.length > 4 && v.length < 20 && !_participants.includes(v + '@s.whatsapp.net'))
                .map(async (v) => [
                    v,
                    await client.onWhatsApp(v + '@s.whatsapp.net'),
                ]),
        )).filter((v) => v[1][0]?.exists).map((v) => v[0] + '@c.us');

        const response = await client.query({
            tag: 'iq',
            attrs: {
                type: 'set',
                xmlns: 'w:g2',
                to: m.chat,
            },
            content: users.map((jid) => ({
                tag: 'add',
                attrs: {},
                content: [{ tag: 'participant', attrs: { jid } }],
            })),
        });

        const add = getBinaryNodeChild(response, 'add');
        const participant = getBinaryNodeChildren(add, 'participant');

        let respon = await client.groupInviteCode(m.chat);

        for (const user of participant.filter((item) => item.attrs.error === 401 || item.attrs.error === 403 || item.attrs.error === 408)) {
            const jid = user.attrs.jid;
            const content = getBinaryNodeChild(user, 'add_request');
            const invite_code = content.attrs.code;
            const invite_code_exp = content.attrs.expiration;

            let teza;
            if (user.attrs.error === 401) {
                teza = `â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œ @${jid.split('@')[0]} has blocked the bot.\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`;
            } else if (user.attrs.error === 403) {
                teza = `â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œ @${jid.split('@')[0]} has set privacy settings for group adding.\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`;
            } else if (user.attrs.error === 408) {
                teza = `â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œ @${jid.split('@')[0]} recently left the group.\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`;
            } 

            await m.reply(teza);

            let links = `â•­â”€â”€â”€(    TOXIC-MD    )â”€â”€â”€\nâ”œâ”€â”€â”€â‰« GROUP INVITE â‰ªâ”€â”€â”€\nâ”œ \nâ”œ ${pushname} is trying to add you to\nâ”œ ${groupMetadata.subject}\nâ”œ \nâ”œ https://chat.whatsapp.com/${respon}\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â˜‰\n> Â©ğğ¨ğ°ğğ«ğğ ğğ² ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§`;

            await client.sendMessage(jid, { text: links }, { quoted: m });
        }
    });
};
